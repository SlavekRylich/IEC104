@startuml
skinparam DefaultFontSize 18

|#whitesmoke|Session|
start
note: spojení vytvořeno
while (Příznak timeout?) is (ne)
    if ( apdu = read(2B) )  is (ne) then
        :TCP spojení ukončeno;
        stop
        note right: spojení\nukončeno
    else (ano)
        if (1. Byte = 0x68) is (ne) then
        else (ano)
            :delka = 2. byte;
            :čti zbytek rámce dle délky\n     apdu = read(delka);
            :ziskani objektu na rámec\nnew_apdu = Parser(apdu);
            :aktualizace časovačů\n          t0, t1, t2, t3;


            |#lightgray|ClientManager|
            (A)
            :callback pro rámec\n   nebo timeout;
            if (rámec?) is (ano) then
                : zpracuj rámec;

                if (data?) is ( ) then
                    |MQTTProtocol /\nModul zpracování|
                    #yellowgreen: předání dat\n do modulu\n zpracování;

                    #tan:     data do \nMQTT Broker;
                else (ne)
                    |#lightgray|ClientManager|
                endif

            else (ne)
            endif
                |#lightgray|ClientManager|
                :  aktualizace\nstavu spojení;
        endif
    endif
endwhile (ano)
:handle_timeout;
if (t1?) is (ano) then
    |#lightgray|ClientManager|
    note left: spojení\nukončeno
    stop

else (ne)
    (A)
    detach
endif
@enduml

                |#lightgray|ClientManager|
                : ulož rámec \ndo databáze;